{% extends "base.html" %}

{% block head %}
<title>TradingView JSON Generator</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<style>
    /* Autocomplete styling */
    .ui-autocomplete {
        max-height: 300px;
        overflow-y: auto;
        overflow-x: hidden;
        z-index: 9999 !important;
    }
    .ui-menu-item {
        padding: 5px;
        font-size: 14px;
    }
    .ui-menu-item:hover {
        background-color: #3b82f6;
        color: #ffffff;
        cursor: pointer;
    }
    .ui-helper-hidden-accessible {
        display: none;
    }
</style>
<script>
    $(document).ready(function() {
        $("#symbol-input").autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "/search/suggestions",
                    dataType: "json",
                    data: {
                        term: request.term,
                        exchange: $("#exchange-select").val()
                    },
                    success: function(data) {
                        response(data);
                    }
                });
            },
            minLength: 1,
            select: function(event, ui) {
                $("#symbol-input").val(ui.item.value);
                return false;
            }
        }).autocomplete("instance")._renderItem = function(ul, item) {
            return $("<li>")
                .append("<div><strong>" + item.value + "</strong> - " + item.label.split(" - ")[1] + "</div>")
                .appendTo(ul);
        };
        
        // Update suggestions when exchange changes
        $("#exchange-select").change(function() {
            if($("#symbol-input").val().length >= 1) {
                $("#symbol-input").autocomplete("search", $("#symbol-input").val());
            }
        });
        
        // Generate JSON button click event
        $("#generate-json").click(function() {
            generateJSON();
        });
        
        function generateJSON() {
            var symbol = $("#symbol-input").val();
            var product = $("#product-select").val();
            var exchange = $("#exchange-select").val();
            
            if(!symbol || !product || !exchange) {
                alert("Please fill all fields");
                return;
            }
            
            $.ajax({
                url: "/tradingview/",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    symbol: symbol,
                    product: product,
                    exchange: exchange
                }),
                success: function(response) {
                    $("#json-output").text(JSON.stringify(response, null, 2));
                    $("#json-container").show();
                },
                error: function(xhr, status, error) {
                    alert("Error generating JSON: " + error);
                }
            });
        }
        
        // Copy JSON button
        $("#copy-json").click(function() {
            var jsonText = $("#json-output").text();
            navigator.clipboard.writeText(jsonText).then(function() {
                alert("JSON copied to clipboard!");
            }, function() {
                alert("Failed to copy JSON!");
            });
        });
        
        // Copy webhook URL button
        $("#copy-webhook").click(function() {
            var webhookUrl = $("#webhook-url").text();
            navigator.clipboard.writeText(webhookUrl).then(function() {
                alert("Webhook URL copied to clipboard!");
            }, function() {
                alert("Failed to copy webhook URL!");
            });
        });
    });
</script>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4 text-center text-primary">TradingView JSON Generator</h1>
    
    <div class="max-w-md mx-auto mb-6">
        <div class="mb-4">
            <label for="symbol-input" class="block mb-2 text-gray-300">Symbol:</label>
            <input type="text" id="symbol-input" class="w-full p-2 border border-gray-700 rounded bg-gray-900 text-gray-300 focus:border-blue-600 focus:ring-blue-600" value="{{ symbol if symbol else '' }}">
        </div>
        
        <div class="mb-4">
            <label for="product-select" class="block mb-2 text-gray-300">Product:</label>
            <select id="product-select" class="w-full p-2 border border-gray-700 rounded bg-gray-900 text-gray-300 focus:border-blue-600 focus:ring-blue-600">
                <option value="MIS">MIS</option>
                <option value="CNC">CNC</option>
                <option value="NRML">NRML</option>
            </select>
        </div>
        
        <div class="mb-4">
            <label for="exchange-select" class="block mb-2 text-gray-300">Exchange:</label>
            <select id="exchange-select" class="w-full p-2 border border-gray-700 rounded bg-gray-900 text-gray-300 focus:border-blue-600 focus:ring-blue-600">
                <option value="NSE">NSE</option>
                <option value="NFO">NFO</option>
                <option value="BSE">BSE</option>
                <option value="BFO">BFO</option>
                <option value="CDS">CDS</option>
                <option value="MCX">MCX</option>
            </select>
        </div>
        
        <button id="generate-json" class="w-full bg-blue-600 text-gray-100 p-2 rounded hover:bg-blue-700 font-bold uppercase">Generate JSON</button>
    </div>
    
    <div id="json-container" class="max-w-2xl mx-auto mb-6 p-4 bg-gray-800 rounded border border-gray-700" style="display: none;">
        <pre id="json-output" class="bg-gray-900 p-2 rounded overflow-x-auto text-gray-300 border border-gray-700"></pre>
        <button id="copy-json" class="mt-2 bg-green-600 text-gray-100 p-2 rounded hover:bg-green-700 font-bold">Copy JSON</button>
    </div>
    
    <div class="max-w-2xl mx-auto p-4 bg-green-900/20 rounded border border-green-700">
        <h2 class="text-xl font-semibold mb-2 text-green-400">TradingView Webhook URL</h2>
        <div class="flex items-center">
            <code id="webhook-url" class="bg-gray-900 p-2 rounded flex-1 overflow-x-auto text-green-400 border border-green-800">{{ host }}/api/v1/placesmartorder</code>
            <button id="copy-webhook" class="ml-2 bg-green-600 text-gray-100 p-2 rounded hover:bg-green-700 font-bold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" />
                </svg>
            </button>
        </div>
    </div>
</div>
{% endblock %}